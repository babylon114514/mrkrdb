/*! MariKore DataBase - v1.2.1 - 2014-04-05
* http://mrkrdb.mgzl.jp/
* Copyright (c) 2014 MegazalRock; Licensed MIT */
!function(window,$,angular){var noSelectText="選択解除";angular.module("mrkrdbApp",["angularLocalStorage"]).controller("SearchCtrl",["$scope","$http","$q","storage","$sce",function($scope,$http,$q,storage){function getResultPages(){var i=0;for($scope.resultPages=[];i<$scope.resultPageMaxIndex;i+=1)$scope.resultPages[i]=i+1}function getResultPageMaxIndex(){$scope.resultPageMaxIndex=Math.ceil($scope.searchResult.length/$scope.itemsPerPage)}function filterRresult(searchBaffer){if(searchBaffer=searchBaffer||$scope.searchResult,"nofilter"===$scope.filter)return searchBaffer;var filterFunction;switch($scope.filter){case"favorite":filterFunction=function(item){return $scope.isFavorited(item.name)};break;case"cookieonly":filterFunction=function(item){return isCookieOnly(item.name)};break;case"zun":filterFunction=function(item){return isCookieOnly(item.name)&&parseFloat(item.cost)<=60};break;case"noskill":filterFunction=function(item){return!item.skillName};break;default:filterFunction=function(){return!0}}return searchBaffer.filter(filterFunction)}function sortResult(searchBaffer){searchBaffer=searchBaffer||$scope.searchResult;var key=$scope.sortKey,order=$scope.sortOrder,pow="DESC"===order?-1:1;return"tekito"!==key&&searchBaffer.length&&(searchBaffer=searchBaffer.sort(function(a,b){return(parseFloat(a[key])>parseFloat(b[key])?1:parseFloat(a[key])<parseFloat(b[key])?-1:0)*pow})),searchBaffer}function isCookieOnly(name){return-1!==$.inArray(name,$scope.gamedata.cookieOnlyList)}function finalizeSearchResult(searchMode,searchBaffer,showAsResult){return showAsResult=showAsResult||!0,showAsResult?($scope.searchMode=searchMode,$scope.currentPageIndex=0,$scope.searchResult=searchBaffer,$scope.showResult(),searchBaffer):searchBaffer}function uniqueItemList(itemList){var results=[],nameList=[];return angular.forEach(itemList,function(item){-1===nameList.indexOf(item.name)&&(nameList.push(item.name),results.push(item))}),results}storage.bind($scope,"favoritedListString",$scope.favoritedListString),storage.bind($scope,"isTinyMode",$scope.isTinyMode),storage.bind($scope,"isSearchSortBoxShow",$scope.isSearchSortBoxShow),storage.bind($scope,"isSearchNumBoxShow",$scope.isSearchNumBoxShow),storage.bind($scope,"isSearchReachBoxShow",$scope.isSearchReachBoxShow),storage.bind($scope,"isSearchNameBoxShow",$scope.isSearchNameBoxShow),storage.bind($scope,"isSearchSkillBoxShow",$scope.isSearchSkillBoxShow),storage.bind($scope,"isSearchTypeBoxShow",$scope.isSearchTypeBoxShow),storage.bind($scope,"isSearchFilterBoxShow",$scope.isSearchFilterBoxShow),storage.bind($scope,"sortOrder",$scope.sortOrder),storage.bind($scope,"sortKey",$scope.sortKey),storage.bind($scope,"itemsPerPage",$scope.itemsPerPage),$scope.searchResult=[],$scope.currentPageIndex=0,$scope.itemsPerPage=$scope.itemsPerPage||114514,$scope._itemsPerPage=$scope.itemsPerPage,$scope.resultPageMinIndex=0,$scope.resultPageMaxIndex=$scope.resultPageMinIndex+$scope.itemsPerPage,$scope.resultPages=[],$scope.searchResultView=[],$scope.searchCondition={selectedTypeList:[],selectedTypes:{},composition:noSelectText,mode:"and",name:"",skill:"",numSearch:{min:null,max:null,key:"cost"},target:"単体",reach:"物理"},$scope.sortOrder=$scope.sortOrder||"ASC",$scope.sortKey=$scope.sortKey||"tekito",$scope.filter="nofilter",$scope.favoritedList=""!==$scope.favoritedListString?$.parseJSON($scope.favoritedListString):[],$scope.wikiUrl="http://marikore.wiki.fc2.com/wiki/",$scope.searchMode="",$q.all([$http.get("app/data/characters.json"),$http.get("app/data/gamedata.json")]).then(function(res){$scope.characters=res[0].data,$scope.gamedata=res[1].data,$scope.searchResult=$scope.characters,$scope.showResult()}),$scope.$watch("searchResult",$scope.showResult),$scope.$watch("itemsPerPage",$scope.showResult),$scope.$watch("resultPageMaxIndex",$scope.showResult),$scope.$watch("currentPageIndex",$scope.showResult),$scope.showResult=function(searchBaffer){if(searchBaffer=searchBaffer||$scope.searchResult,getResultPages(),getResultPageMaxIndex(),searchBaffer=sortResult(filterRresult(searchBaffer)),$scope.searchResultLength=searchBaffer.length,$scope.itemsPerPage>1){$scope.searchResultView=[];var min=$scope.itemsPerPage*$scope.currentPageIndex,max=$scope.itemsPerPage*$scope.currentPageIndex+$scope.itemsPerPage;min!==max&&(max>searchResult.length&&(max=searchResult.length),$scope.searchResultView=searchBaffer.slice(min,max))}else $scope.searchResultView=searchBaffer},$scope.changeFilter=function(){$scope.showResult()},$scope.resetSearch=function(){$scope.searchCondition={selectedTypeList:[],selectedTypes:{},composition:noSelectText,mode:"and",name:"",skill:"",numSearch:{min:null,max:null,key:"cost"},target:"単体",reach:"物理"},$scope.sortOrder="ASC",$scope.sortKey="tekito",$scope.filter="nofilter",$scope.searchResult=$scope.characters,$scope.showResult($scope.characters)},$scope.changeItemsPerPage=function(){$scope.itemsPerPage!==$scope._itemsPerPage&&($scope.itemsPerPage=parseInt($scope._itemsPerPage,10)||1,$scope.currentPageIndex=0,console.log($scope.itemsPerPage))},$scope.changeResultPageTo=function(pageIndex){$scope.currentPageIndex=pageIndex},$scope.changeResultPageNext=function(){var index=$scope.currentPageIndex+1;index<$scope.resultPageMaxIndex&&$scope.changeResultPageTo(index)},$scope.changeResultPagePrev=function(){var index=$scope.currentPageIndex-1;index>=0&&$scope.changeResultPageTo(index)},$scope.toggleTypeCheckbox=function(type){var index=$scope.searchCondition.selectedTypeList.indexOf(type);-1!==index?$scope.searchCondition.selectedTypeList.splice(index,1):$scope.searchCondition.selectedTypeList.push(type),$scope.typeSearch(!0)},$scope.typeSearch=function(showAsResult){var mode=$scope.searchCondition.mode,types=$scope.searchCondition.selectedTypeList,typesLength=types.length,result=[],searchBaffer=$scope.characters;showAsResult!==!0&&(showAsResult=!1),typesLength>0&&("and"===mode?angular.forEach(types,function(type){searchBaffer=searchBaffer.filter(function(item){return-1!==$.inArray(type,item.types)?!0:void 0})}):"or"===mode&&(angular.forEach(types,function(type){result=result.concat(searchBaffer.filter(function(item){return-1!==$.inArray(type,item.types)?!0:void 0}))}),searchBaffer=uniqueItemList(result))),finalizeSearchResult("type",searchBaffer,showAsResult)},$scope.compositionSearch=function(showAsResult){var composition=$scope.searchCondition.composition,searchBaffer=$scope.characters;showAsResult!==!0&&(showAsResult=!1),composition!==noSelectText&&(searchBaffer=searchBaffer.filter(function(item){for(var i=0,length=item.compositionList.length;length>i;i+=1)if(-1!==$.inArray(composition,item.compositionList[i].with)||item.compositionList[i].base===composition||item.compositionList[i].to===composition)return!0})),finalizeSearchResult("composition",searchBaffer,showAsResult)},$scope.search=function(searchMode){$scope.searchMode=searchMode},$scope.nameSearch=function(showAsResult){var searchRegexp,searchBaffer=$scope.characters,str=$scope.searchCondition.name;showAsResult!==!0&&(showAsResult=!1),angular.isString(str)&&""!==str&&(searchRegexp=new RegExp(str.toLowerCase(),"i"),searchBaffer=searchBaffer.filter(function(item){return searchRegexp.test(item.name)?!0:void 0})),finalizeSearchResult("name",searchBaffer,showAsResult)},$scope.skillTextSearch=function(showAsResult){var searchRegexp,searchBaffer=$scope.characters,str=$scope.searchCondition.skill;showAsResult!==!0&&(showAsResult=!1),angular.isString(str)&&""!==str&&(searchRegexp=new RegExp(str.toLowerCase(),"i"),searchBaffer=searchBaffer.filter(function(item){return searchRegexp.test(item.skillDescription)||searchRegexp.test(item.skillName)?!0:void 0})),finalizeSearchResult("skill",searchBaffer,showAsResult)},$scope.numSearch=function(showAsResult){var min=$scope.searchCondition.numSearch.min,max=$scope.searchCondition.numSearch.max,key=$scope.searchCondition.numSearch.key,searchBaffer=$scope.characters;showAsResult!==!0&&(showAsResult=!1),null!==min&&angular.isNumber(min)||(min=-1/0),null!==max&&angular.isNumber(max)||(max=1/0),searchBaffer=searchBaffer.filter(function(item){return min<=item[key]&&item[key]<=max?!0:void 0}),finalizeSearchResult("num",searchBaffer,showAsResult)},$scope.searchReach=function(showAsResult){var searchBaffer=[],reach=$scope.searchCondition.reach,target=$scope.searchCondition.target;showAsResult!==!0&&(showAsResult=!1),searchBaffer=$scope.characters.filter(function(item){return item.reach===reach&&item.target===target?!0:void 0}),finalizeSearchResult("reach",searchBaffer,showAsResult)},$scope.toggleItemFavorite=function(name){var index=$scope.favoritedList.indexOf(name);-1!==index?$scope.favoritedList.splice(index,1):$scope.favoritedList.push(name),$scope.favoritedListString=JSON.stringify($scope.favoritedList)},$scope.isFavorited=function(name){return-1!==$scope.favoritedList.indexOf(name)},$scope.showFavorite=function(){$scope.filter="favorite",finalizeSearchResult("favorite",$scope.characters)},$scope.isEventFinished=function(placeName){return angular.isUndefined($scope.gamedata.eventList[placeName])?!1:$scope.gamedata.eventList[placeName].isFinished},$scope.toggleTinyMode=function(){$scope.isTinyMode=$scope.isTinyMode?!1:!0},$scope.toggleSearchBox=function(valueName){$scope[valueName]=!$scope[valueName]}}])}(this,jQuery,angular);