/*! MariKore DataBase - v1.1.3 - 2014-03-26
* http://mrkrdb.mgzl.jp/
* Copyright (c) 2014 MegazalRock; Licensed MIT */
!function(window,$,angular){var noSelectText="選択解除";angular.module("mrkrdbApp",["angularLocalStorage"]).controller("SearchCtrl",["$scope","$http","$q","storage","$sce",function($scope,$http,$q,storage){function showPagedView(){if(console.log($scope.itemsPerPage),$scope.itemsPerPage>1){$scope.searchResultView=[];var min=$scope.itemsPerPage*$scope.currentPageIndex,max=$scope.itemsPerPage*$scope.currentPageIndex+$scope.itemsPerPage;min!==max&&(max>$scope.searchResult.length&&(max=$scope.searchResult.length),$scope.searchResultView=$scope.searchResult.slice(min,max))}else $scope.searchResultView=$scope.searchResult}function getResultPages(){var i=0;for($scope.resultPages=[];i<$scope.resultPageMaxIndex;i+=1)$scope.resultPages[i]=i+1}function getResultPageMaxIndex(){$scope.resultPageMaxIndex=Math.ceil($scope.searchResult.length/$scope.itemsPerPage)}function uniqueItemList(itemList){var results=[],nameList=[];return angular.forEach(itemList,function(item){-1===nameList.indexOf(item.name)&&(nameList.push(item.name),results.push(item))}),results}storage.bind($scope,"favoritedListString",$scope.favoritedListString),storage.bind($scope,"isTinyMode",$scope.isTinyMode),storage.bind($scope,"isSearchSortBoxShow",$scope.isSearchSortBoxShow),storage.bind($scope,"isSearchNumBoxShow",$scope.isSearchNumBoxShow),storage.bind($scope,"isSearchReachBoxShow",$scope.isSearchReachBoxShow),storage.bind($scope,"isSearchNameBoxShow",$scope.isSearchNameBoxShow),storage.bind($scope,"isSearchSkillBoxShow",$scope.isSearchSkillBoxShow),storage.bind($scope,"isSearchTypeBoxShow",$scope.isSearchTypeBoxShow),storage.bind($scope,"sortOrder",$scope.sortOrder),storage.bind($scope,"sortKey",$scope.sortKey),storage.bind($scope,"itemsPerPage",$scope.itemsPerPage),$scope.searchResult=[],$scope.currentPageIndex=0,$scope.itemsPerPage=$scope.itemsPerPage||114514,$scope._itemsPerPage=$scope.itemsPerPage,$scope.resultPageMinIndex=0,$scope.resultPageMaxIndex=$scope.resultPageMinIndex+$scope.itemsPerPage,$scope.resultPages=[],$scope.searchResultView=[],$scope.searchCondition={selectedTypeList:[],selectedTypes:{},composition:noSelectText,mode:"and",name:"",skill:"",numSearch:{min:null,max:null,key:"cost"},target:"単体",reach:"物理"},$scope.sortOrder=$scope.sortOrder||"ASC",$scope.sortKey=$scope.sortKey||"tekito",$scope.favoritedList=""!==$scope.favoritedListString?$.parseJSON($scope.favoritedListString):[],$scope.wikiUrl="http://marikore.wiki.fc2.com/wiki/",$scope.searchMode="",$q.all([$http.get("app/data/characters.json"),$http.get("app/data/gamedata.json")]).then(function(res){$scope.characters=res[0].data,$scope.gamedata=res[1].data,$scope.searchResult=$scope.characters}),$scope.$watch("searchResult",getResultPageMaxIndex),$scope.$watch("itemsPerPage",getResultPageMaxIndex),$scope.$watch("resultPageMaxIndex",getResultPages),$scope.$watch("itemsPerPage",getResultPages),$scope.$watch("searchResult",showPagedView),$scope.$watch("itemsPerPage",showPagedView),$scope.$watch("currentPageIndex",showPagedView),$scope.changeItemsPerPage=function(){$scope.itemsPerPage!==$scope._itemsPerPage&&($scope.itemsPerPage=parseInt($scope._itemsPerPage,10)||1,$scope.currentPageIndex=0,console.log($scope.itemsPerPage))},$scope.changeResultPageTo=function(pageIndex){$scope.currentPageIndex=pageIndex},$scope.changeResultPageNext=function(){var index=$scope.currentPageIndex+1;index<$scope.resultPageMaxIndex&&$scope.changeResultPageTo(index)},$scope.changeResultPagePrev=function(){var index=$scope.currentPageIndex-1;index>=0&&$scope.changeResultPageTo(index)},$scope.toggleTypeCheckbox=function(type){var index=$scope.searchCondition.selectedTypeList.indexOf(type);-1!==index?$scope.searchCondition.selectedTypeList.splice(index,1):$scope.searchCondition.selectedTypeList.push(type),$scope.typeSearch(!0)},$scope.typeSearch=function(showAsResult){var mode=$scope.searchCondition.mode,types=$scope.searchCondition.selectedTypeList,typesLength=types.length,result=[],searchBaffer=$scope.characters;return showAsResult!==!0&&(showAsResult=!1),typesLength>0&&("and"===mode?angular.forEach(types,function(type){searchBaffer=searchBaffer.filter(function(item){return-1!==$.inArray(type,item.types)?!0:void 0})}):"or"===mode&&(angular.forEach(types,function(type){result=result.concat(searchBaffer.filter(function(item){return-1!==$.inArray(type,item.types)?!0:void 0}))}),searchBaffer=uniqueItemList(result))),searchBaffer=$scope.sortResult(!1,searchBaffer),showAsResult?($scope.searchMode="type",$scope.searchResult=searchBaffer,searchBaffer):searchBaffer},$scope.compositionSearch=function(showAsResult){var composition=$scope.searchCondition.composition,searchBaffer=$scope.characters;return showAsResult!==!0&&(showAsResult=!1),composition!==noSelectText&&(searchBaffer=searchBaffer.filter(function(item){for(var i=0,length=item.compositionList.length;length>i;i+=1)if(-1!==$.inArray(composition,item.compositionList[i].with)||item.compositionList[i].base===composition||item.compositionList[i].to===composition)return!0})),searchBaffer=$scope.sortResult(!1,searchBaffer),showAsResult?($scope.searchMode="composition",$scope.searchResult=searchBaffer,searchBaffer):searchBaffer},$scope.nameSearch=function(showAsResult){var searchRegexp,searchBaffer=$scope.characters,str=$scope.searchCondition.name;return showAsResult!==!0&&(showAsResult=!1),angular.isString(str)&&""!==str&&(searchRegexp=new RegExp(str.toLowerCase(),"i"),searchBaffer=searchBaffer.filter(function(item){return searchRegexp.test(item.name)?!0:void 0})),searchBaffer=$scope.sortResult(!1,searchBaffer),showAsResult?($scope.searchMode="name",$scope.searchResult=searchBaffer,searchBaffer):searchBaffer},$scope.skillTextSearch=function(showAsResult){var searchRegexp,searchBaffer=$scope.characters,str=$scope.searchCondition.skill;return showAsResult!==!0&&(showAsResult=!1),angular.isString(str)&&""!==str&&(searchRegexp=new RegExp(str.toLowerCase(),"i"),searchBaffer=searchBaffer.filter(function(item){return searchRegexp.test(item.skillDescription)||searchRegexp.test(item.skillName)?!0:void 0})),searchBaffer=$scope.sortResult(!1,searchBaffer),showAsResult?($scope.searchMode="skill",$scope.searchResult=searchBaffer,searchBaffer):searchBaffer},$scope.numSearch=function(showAsResult){var min=$scope.searchCondition.numSearch.min,max=$scope.searchCondition.numSearch.max,key=$scope.searchCondition.numSearch.key,searchBaffer=$scope.characters;return showAsResult!==!0&&(showAsResult=!1),null!==min&&angular.isNumber(min)||(min=-1/0),null!==max&&angular.isNumber(max)||(max=1/0),searchBaffer=searchBaffer.filter(function(item){return min<=item[key]&&item[key]<=max?!0:void 0}),searchBaffer=$scope.sortResult(!1,searchBaffer),showAsResult?($scope.searchMode="num",$scope.searchResult=searchBaffer,searchBaffer):searchBaffer},$scope.searchReach=function(showAsResult){var searchBaffer=[],reach=$scope.searchCondition.reach,target=$scope.searchCondition.target;return showAsResult!==!0&&(showAsResult=!1),searchBaffer=$scope.characters.filter(function(item){return item.reach===reach&&item.target===target?!0:void 0}),searchBaffer=$scope.sortResult(!1,searchBaffer),showAsResult?($scope.searchMode="reach",$scope.searchResult=searchBaffer,searchBaffer):searchBaffer},$scope.sortResult=function(showAsResult,itemList){var searchBaffer=itemList||$scope.searchResult,key=$scope.sortKey,order=$scope.sortOrder,pow="DESC"===order?-1:1;return showAsResult!==!0&&(showAsResult=!1),"tekito"!==key&&searchBaffer.length&&(searchBaffer=searchBaffer.sort(function(a,b){return(parseFloat(a[key])>parseFloat(b[key])?1:parseFloat(a[key])<parseFloat(b[key])?-1:0)*pow})),showAsResult?($scope.searchResult=searchBaffer,searchBaffer):searchBaffer},$scope.toggleItemFavorite=function(name){var index=$scope.favoritedList.indexOf(name);-1!==index?$scope.favoritedList.splice(index,1):$scope.favoritedList.push(name),$scope.favoritedListString=JSON.stringify($scope.favoritedList)},$scope.isFavorited=function(name){return-1!==$scope.favoritedList.indexOf(name)},$scope.showFavorite=function(){var searchBaffer=[];angular.forEach($scope.favoritedList,function(name){searchBaffer=searchBaffer.concat($scope.characters.filter(function(item){return name===item.name?!0:void 0}))}),$scope.searchMode="favorite",searchBaffer=uniqueItemList(searchBaffer),searchBaffer=$scope.sortResult(!1,searchBaffer),$scope.searchResult=searchBaffer},$scope.isEventFinished=function(placeName){return angular.isUndefined($scope.gamedata.eventList[placeName])?!1:$scope.gamedata.eventList[placeName].isFinished},$scope.toggleTinyMode=function(){$scope.isTinyMode=$scope.isTinyMode?!1:!0},$scope.toggleSearchBox=function(valueName){$scope[valueName]=!$scope[valueName]}}])}(this,jQuery,angular);